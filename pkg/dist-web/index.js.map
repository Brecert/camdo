{"version":3,"file":"index.js","sources":["../dist-src/command-client.js"],"sourcesContent":["// todo(brecert): document and commentate code\r\nexport default class CommandClient {\r\n    constructor() {\r\n        this.commands = new Map;\r\n        this.types = new Map;\r\n        this.handlers = new Map;\r\n        this.types.set('any', {\r\n            id: 'any',\r\n            display: 'anything',\r\n            validate: val => true\r\n        });\r\n    }\r\n    defineType(opts) {\r\n        const defaults = {\r\n            id: opts.id,\r\n            display: opts.id,\r\n            validate: (val) => true\r\n        };\r\n        this.types.set(opts.id, { ...defaults, ...opts });\r\n    }\r\n    defineArg(arg) {\r\n        const defaults = {\r\n            id: arg.id,\r\n            name: arg.id,\r\n            description: arg.id,\r\n            type: \"any\",\r\n            capture: true,\r\n            required: true\r\n        };\r\n        return { ...defaults, ...arg };\r\n    }\r\n    defineCommand(cmd) {\r\n        const defaults = {\r\n            ...cmd,\r\n            name: cmd.name || cmd.id,\r\n            description: cmd.description || cmd.name || cmd.id,\r\n            args: (cmd.args || []).map(this.defineArg)\r\n        };\r\n        this.commands.set(defaults.id, defaults);\r\n    }\r\n    validateArgs(args, cmd, handler) {\r\n        let data = {};\r\n        return {\r\n            validated: cmd.args.every((cmdArg, i) => {\r\n                let arg = args[i] || cmdArg.default_value;\r\n                if (!this.types.has(cmdArg.type)) {\r\n                    throw `${cmdArg.type} on ${cmdArg.id} is not currently registered`;\r\n                }\r\n                // if not required and undefined then skip validation\r\n                if (!cmdArg.required && arg === undefined) {\r\n                    return true;\r\n                }\r\n                let validated = this.types.get(cmdArg.type).validate(arg);\r\n                data = { cmdArg, failedArg: arg };\r\n                return validated;\r\n            }),\r\n            data\r\n        };\r\n    }\r\n    async addHandler(params) {\r\n        this.handlers.set(params.id, params);\r\n        let handler = this.handlers.get(params.id);\r\n        this.commands.forEach((cmd) => {\r\n            handler.event(async (args, ...passedData) => {\r\n                try {\r\n                    let validated = this.validateArgs(args, cmd, handler);\r\n                    if (validated.validated) {\r\n                        let retArgs = cmd.args\r\n                            .filter(cmdArg => cmdArg.capture)\r\n                            .map((cmdArg, i) => {\r\n                            let arg = args[i] || cmdArg.default_value;\r\n                            return arg;\r\n                        });\r\n                        const data = await cmd.run(retArgs);\r\n                        handler.send(data, ...passedData);\r\n                    }\r\n                    else {\r\n                        handler.send(this.failedMessage(validated.data.cmdArg, validated.data.failedArg), ...passedData);\r\n                    }\r\n                }\r\n                catch (err) {\r\n                    console.error(err);\r\n                }\r\n            }, cmd);\r\n        });\r\n    }\r\n    failedMessage(cmdArg, failedArg) {\r\n        return {\r\n            name: \"ERROR\",\r\n            title: `Expected type \"${cmdArg.type}\" at argument \"${cmdArg.id}\" not \"${failedArg}\"`,\r\n            description: cmdArg.fail_message || `argument \"${cmdArg.id}\" does not accept \\`${failedArg}\\`.`,\r\n            color: 0xdd3344\r\n        };\r\n    }\r\n}\r\n"],"names":[],"mappings":"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"}